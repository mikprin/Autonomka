<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-gb">
	<link rel="self" type="application/atom+xml" href="http://skysedge.us/forum/app.php/feed/topic/1486" />

	<title>A Forum at Sky's Edge</title>
	<subtitle>Community Forum for Sky&#039;s Edge Hardware</subtitle>
	<link href="http://skysedge.us/forum/index.php" />
	<updated>2020-07-10T14:42:02</updated>

	<author><name><![CDATA[A Forum at Sky's Edge]]></name></author>
	<id>http://skysedge.us/forum/app.php/feed/topic/1486</id>

		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-07-10T14:42:02</updated>

		<published>2020-07-10T14:42:02</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1613#p1613</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1613#p1613"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1613#p1613"><![CDATA[
<strong class="text-strong">Doubling battery life</strong><br><br>I just achieved 48 hour battery life by allowing the FONA to go to idle. Idle state is possible by forcing the FONA Rx pin low (normal RS232 idle state is high). While in idle the FONA consumes approx 5mA (depending on RF band), it will still receive calls and send URCs (Unsolicited Response Codes) on the Tx pin, e.g. caller ID.<br><br>The FONA is woken up and able to receive commands over it's UART by setting the FONA Rx pin high and pulsing FONA DTR low.<br><br>Even longer battery life would possible if I didn't wake the FONA ever 10s to check for a time update (I don't know how long it takes for the FONA to switch to idle) but it's a significant improvement already... and the FONA RI pin could be used to wake the ATmega from sleep. It's entirely feasible this phone could work for 10 days standby on one charge.<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Fri Jul 10, 2020 2:42 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-06-16T12:05:53</updated>

		<published>2020-06-16T12:05:53</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1609#p1609</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1609#p1609"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1609#p1609"><![CDATA[
This might work (for unmodified boards) but it's a bit of a kludge:<br><div class="codebox"><p>CODE: </p><pre><code>// Put this with the other includes near the top of the sketch#include &lt;Adafruit_SleepyDog.h&gt;// Put this in setup()int countdownMS = Watchdog.enable(4000);// Either put this immediately after display.init(115200);pinMode(SS, INPUT_PULLUP);// or this, if you're sure the board will never be tested without a FONApinMode(SS, INPUT);// Put this somewhere in loop() where it will be called once per loopWatchdog.reset();</code></pre></div>The pinMode instruction removes the conflict between FONA Tx and SPI SS but does not avoid lockup when SS is pulled low during a display update.<br><br>The rest of the code resets the board if the ATmega locks up. A full display update takes almost 3s so a watchdog timeout of 4s is about right.<br><br>However I won't be supporting this. The more reliable option is to solder a new connection for FONA Tx which is what I've done with my boards. Any firmware I develop will require this hardware mod.<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Tue Jun 16, 2020 12:05 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-06-15T20:31:45</updated>

		<published>2020-06-15T20:31:45</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1608#p1608</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1608#p1608"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1608#p1608"><![CDATA[
<strong class="text-strong">The short answer!</strong><br><br>If not rewiring the FONA Tx pin, then insert:<br><div class="codebox"><p>CODE: </p><pre><code>pinMode(SS, INPUT_PULLUP);  // Set SS' pin as input, the pullup ensures this doesn't halt the ATmega if the pin is floating low (no FONA)</code></pre></div>after <em class="text-italics">display.init(115200);</em> but note the ATmega halts if SS is pulled low during a display update.<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Mon Jun 15, 2020 8:31 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-06-16T00:29:02 </updated>

		<published>2020-06-14T22:22:41</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1605#p1605</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1605#p1605"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1605#p1605"><![CDATA[
Hi Justine, good to see you back. I guessed you must be very busy and also working on the 4G kit but between all of us here we're getting the 3G model covered.<br><br>This evening I modded my spare board so the FONA Tx pin is wired to the original Arduino digital pin 53. I modified my simple test sketch (posted earlier on this forum) to variously; set SS pinMode, initialise display, write display, on different button pushes.<br><br>I confirmed/discovered [updated]:<ul><li>the ATmega SS pin mode is set to output high as soon as display.init is called</li><li>setting pinMode(SS, INPUT_PULLUP); does remove the conflict*, the FONA can send to the ATmega (thanks Chaza)</li><li>the display stops working if SS is pulled low during a display update.</li></ul>* It's important to keep this pin high, especially when the FONA is not installed (if it is, the pullup won't hurt anyway). Fortunately the idle state for 'RS232 TTL serial' is defined as 1.<br><br>Please don't blame the messenger! I really want this to work without a board hardware mod.<br><br>There's probably a workaround, perhaps some direct register setting to change SPI back to master (as well as SS pinMode). I'll have a look when I get the chance but I can't promise anything. But there's a risk of something adverse happening if the FONA Tx sends data during a display update. In this case the ATmega SPI switches from master to slave and the display will fail to update. There's nothing we can do about this mode switching, its hardcoded in the ATmega.<br><br>If anyone is nervous about the wire change but is going to try anyway (i.e. don't blame me), I have two suggestions;<br><br><strong class="text-strong">The neat way:</strong><br>This is the method I used (see photos in my GitHub fork). Don't slice the track, press the tip of a scapel down, more like a chisel than a knife, scrape the solder resist off the via as gently as possible so as not to break the through hole connection. I find a x6 illuminated magnifier works well for me (a good compromise between magnification and working distance) and I have a needle tipped soldering iron.<br><br><strong class="text-strong">The other way:</strong><br>Destroy the via connection to hardware pin 19 (the SS pin), either cut the track or destroy the via through hole with a 0.8mm drill. Take a fine connecting wire (excess mic lead works) from the ATmega hardware pin 25 (corner pins are less tricky to solder) direct to the header pad for the FONA Tx pin. But you can't easily go back with this method.<br><br><strong class="text-strong">Update:</strong> the SPI can be switched back to master with:<div class="codebox"><p>CODE: </p><pre><code>SPCR |= (1&lt;&lt;MSTR);</code></pre></div>However This is not enough because when the FONA pulls SS low during a display update, the ATmega hangs. There's the SPIF interrupt to sort out and clear. From the ATmega2560 datasheet:  <em class="text-italics">If SS is an input and is driven low when the SPI is in Master mode, this will also set the SPIF Flag.</em><br><br><strong class="text-strong">Further reading:</strong><br><a href="http://maxembedded.com/2013/11/the-spi-of-the-avr/#SS" class="postlink">maxembedded.com/2013/11/the-spi-of-the-avr</a><br><a href="http://ww1.microchip.com/downloads/en/DeviceDoc/ATmega640-1280-1281-2560-2561-Datasheet-DS40002211A.pdf" class="postlink">ATmega2560 datasheet. See section 21.1, SS' Pin Functionality</a><p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Sun Jun 14, 2020 10:22 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[paedipod]]></name></author>
		<updated>2020-06-14T20:46:44</updated>

		<published>2020-06-14T20:46:44</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1604#p1604</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1604#p1604"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1604#p1604"><![CDATA[
Hi All,<br><br>Away for a while....after wrecking my display, the new one(s) arrived from AliExpress on Friday. So, removed and reinstalled (thanks SteveC for the tips posted elsewhere, I can now case/uncase the phone in minutes instead of hours.)<br><br>Anyway thanks chaza for the "solution" to the pin problem. I too am a little under skilled for soldering a 0.2mm wire to anything. Things seem to be working so far.....although have not been able to make the missed call function work. <br><br>And thanks SteveC for posting everything up here and in GitHub, although I don't think that I can use the fork without the hardware modification. Seems like the battery level and signal strength now working as intended.  I have the date display working but still getting the time as  00:00.<br><br>So much improved functionality since last check in....now to start bending the display!<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1748">paedipod</a> — Sun Jun 14, 2020 8:46 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[chaza]]></name></author>
		<updated>2020-06-12T21:04:05</updated>

		<published>2020-06-12T21:04:05</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1601#p1601</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1601#p1601"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1601#p1601"><![CDATA[
Thanks Steve -- I should have known about that Code block format but have not used it (don't do much posting) -- will use in the future. <br>I just checked and putting the pinMode(SS, INPUT) at the end of setup() is sufficient by itself. So, it looks like once the display is initialized then it is unaffected by this. I will do some more testing but so far this seems ok. As I mentioned, I can see very little on my display at the moment (!) but from what I see there, and from serial output to a terminal, the reading of the serial output from the FONA is ok.<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1749">chaza</a> — Fri Jun 12, 2020 9:04 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[justine]]></name></author>
		<updated>2020-06-12T13:20:35</updated>

		<published>2020-06-12T13:20:35</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1600#p1600</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1600#p1600"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1600#p1600"><![CDATA[
Steve et al,<br><br>I just wanted to say thank you for all your effort and attention. I've been swamped lately getting in a proposal for my day job and I'm trying to get back to phone stuff. Also have pre-existing robotics stuff for Sky's Edge that I need to get off my plate. But anyway, I'm really happy to see this activity and will <em class="text-italics">eventually</em> catch up on all the progress.<br><br>~Justine<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=2">justine</a> — Fri Jun 12, 2020 1:20 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-06-12T14:09:45 </updated>

		<published>2020-06-12T11:41:01</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1599#p1599</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1599#p1599"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1599#p1599"><![CDATA[
Thanks Chaza, it's great to know there's a way to get the FONA serial comms working without a hardware mod. This should be very useful for those not building from bare boards. I think you could put this anywhere in the main loop so long as it's called once per loop:<br><div class="codebox"><p>CODE: </p><pre><code>pinMode(SS, INPUT);</code></pre></div>I find it easier to read code when it's in a code block like this.<br><br>I timed my loop, each main loop takes 106us [updated] so this resets the SS pin mode 9430 times a second (mileage may vary). Does the display continue to work without re-initialising it? Btw nice use of the <em class="text-italics">sscanf</em> method  <img class="smilies" src="http://skysedge.us/forum/images/smilies/icon_e_biggrin.gif" width="15" height="17" alt=":D" title="Very Happy"> <br><br>Tip for buying displays from AliExpress: I use the AliExpress shipment method for a good compromise between cost and speed plus it's tracked end to end. Waveshare ship especially fast through AliExpress, I receive their parts (UK) in about 10 calendar days.<br><br>Thanks<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Fri Jun 12, 2020 11:41 am</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[chaza]]></name></author>
		<updated>2020-06-11T20:18:16</updated>

		<published>2020-06-11T20:18:16</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1598#p1598</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1598#p1598"/>
		<title type="html"><![CDATA[Example function to get last unanswered call]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1598#p1598"><![CDATA[
Yes, there is some "unsafe" syntax here (not checking string limits, etc.) but I'll throw it out here as an example. This gets the last missed (unanswered) phone number. I added this to Functions.ino and a call to it in DisplayContacts() and I can display the number in place of "???-????". I use "display" very loosely in this context because, on my e-ink display, I can barely read anything! I basically ruined it early on in manhandling my phone build and trying to get it all together. Like others here, I'm waiting for a slow boat from China to deliver additional displays (I only had the one). <br><br>Note that my FONAserialReceive() is modified somewhat from the base code but I'm not sure it matters here. Also, I have a FONAserialClearBuffer function that reads and discards anything in the serial output buffer -- just in case there is anything lingering in there. The code below shows some examples of what I expect FONAserialReceive() to deposit in the ReceivedChars buffer.<br><br>-- caller must allocate space for the returned parameter. Example call:<br>                        char timeDateStr[64] = "???-????";<br>getLastMissedCall(missedNumber);<br>display.print(missedNumber);<br><br><br>void getLastMissedCall(char *missedNumber){<br>  int numValues = 0;<br>  char mN[64];<br>  int phoneNumberType;  // expect 129 or 145<br>  char temp[64];<br><br>    FONAserialClearBuffer();<br>    FONAserial.println("AT+CPBS=\"MC\"");  // Select ME missed (unanswered received) calls list                                   <br>                                                              // Capacity: max. 10 entries<br>    delay(250);<br>    FONAserialReceive();<br>    Serial.println(ReceivedChars);  <br>    <br>    FONAserial.println("AT+CPBR=1,1");     // ask for the first in the list (last received)<br>    delay(250);<br>    FONAserialReceive();<br>    Serial.println(ReceivedChars);<br><br>// Example return values:<br>//    AT+CPBR=1,1+CPBR:1,"11235551234",129,""<br>//    AT+CPBR=1,1+CPBR:1,"+11235551234",145,""<br><br>    numValues = sscanf (ReceivedChars, "AT+CPBR=1,1+CPBR:1,\"%[+0123456789]\",%d,\"\"", mN, &amp;phoneNumberType);<br><br>    Serial.println("In getLastMissedCall");<br>    Serial.print("mN: ");<br>    Serial.println(mN);<br>    Serial.print("phoneNumberType: ");<br>    sprintf(temp, "%d", phoneNumberType);<br>    Serial.println(temp);<br><br>    if (mN[0] == '+')<br>    {<br>// Get rid of the plus sign<br>strcpy(missedNumber, mN+1);<br>    }<br>    else<br>    {<br>strcpy(missedNumber, mN);<br>    }<br><br>    // Restore default<br>    FONAserial.println("AT+CPBS");  // Restore default to "SM" (SIM phonebook)<br>    delay(250);<br>    FONAserialReceive();<br><br>}<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1749">chaza</a> — Thu Jun 11, 2020 8:18 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[chaza]]></name></author>
		<updated>2020-06-11T15:53:46</updated>

		<published>2020-06-11T15:53:46</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1597#p1597</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1597#p1597"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1597#p1597"><![CDATA[
Hi Steve --  I agree that your hardware fix fixes this issue. Personally, I will not attempt it however because <br>neither my hand dexterity or eyesight is good enough to attempt this fix (getting old ...).<br><br>The "pinMode(SS, INPUT)" workaround seems to be working ok for me. I placed this in the loop() function after <br>the checks for the "mode switches".<br><br>The biggest issue I found with making serial read calls is that if the SoftwareSerial buffer is not flushed after making calls<br>then any subsequent call you make, and attempt to read/interpret the output, will get the combined output of "unflushed" previous calls<br>as well as the one you just made. I think you have pointed this out as well. I added calls to FONAserialReceive to read out the buffer<br>after every call to FONAserial.println. In most cases we are not interested in the output but it's important to flush the buffer. <br>I also modified FONAserialReceive() to check for "ERROR" as well as "OK" as a message <br>terminator. I found that some of the calls in the code were returning errors (and that "ERROR" terminator). Specifically:<br><br>In setup()<br>FONAserial.println("AT+VMUTE=0");//Set speaker mute to OFF<br>  The "AT Command Set -- SIM5320 _ATC_V1.23" manual specifies that this can only be called during a connected call.<br>  Called here it returns an error. I've removed this call since it's not needed.<br>  <br>In RotaryIn()<br>FONAserial.print("AT+VTS=");//Send DTMF tone over network (for menu entries, etc).<br>  The "AT Command Set -- SIM5320 _ATC_V1.23" manual specifies that this can only be used in voice mode of operation (active voice call)<br>  I left this call in but read out and discard the output with FONAserialReceive. In the context of a call this should return "OK" but I've<br>  not tried that. In most cases (just turning the dial before a connected call in Modes 1 or 2) this will return "ERROR".<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1749">chaza</a> — Thu Jun 11, 2020 3:53 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-06-09T16:15:19</updated>

		<published>2020-06-09T16:15:19</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1594#p1594</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1594#p1594"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1594#p1594"><![CDATA[
<blockquote class="uncited"><div>Anyone support my (reluctant) view that a hardware mod (moving the FONA Tx wire) is the way forward?</div></blockquote>No feedback? I'm 90%+ sure re-wiring the FONA Tx pin is the best way forward but feedback would be appreciated.<br><br>For anyone who has implemented the mod, my firmware contribution now includes a working hook status LED for incoming calls. The firmware checks for unsolicited messages from the FONA once every second; caller ID, call begin and call end.<br><br><a href="https://github.com/riosil/RotaryCellphone" class="postlink">https://github.com/riosil/RotaryCellphone</a><br><br>PS: or to rephrase, has anyone got the ATmega microcontroller to receive serial messages from the FONA <strong class="text-strong">without</strong> rewiring the FONA Tx pin?<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Tue Jun 09, 2020 4:15 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-05-26T22:56:55</updated>

		<published>2020-05-26T22:56:55</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1584#p1584</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1584#p1584"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1584#p1584"><![CDATA[
<strong class="text-strong">Firmware now fully working as intended</strong>  <img class="smilies" src="http://skysedge.us/forum/images/smilies/icon_e_biggrin.gif" width="15" height="17" alt=":D" title="Very Happy"> <br><br>Try this fork: <a href="https://github.com/riosil/RotaryCellphone" class="postlink">https://github.com/riosil/RotaryCellphone</a><br><br>But the wire from FONA Tx to ATmega hardware pin 19 must be moved to pin 25 (nearest corner pin). See photo on first page of this thread.<br><br>These are the startup messages over USB showing reliable communication from the FONA plus signal strength and battery charge levels:<br><div class="inline-attachment"><dl class="file"><dt class="attach-image"><img src="http://skysedge.us/forum/download/file.php?id=27" class="postimage" alt="new_rx_monitor.jpg" onclick="viewableArea(this);" /></dt></dl></div>Does anyone have an easier fix?<br><br>No new features in this branch (yet) - just everything working as I believe Justine intended.<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Tue May 26, 2020 10:56 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[SteveC]]></name></author>
		<updated>2020-05-25T23:55:32</updated>

		<published>2020-05-25T23:55:32</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1583#p1583</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1583#p1583"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1583#p1583"><![CDATA[
Thanks for posting your results Chaza. It helps me know I'm not going crazy  <img class="smilies" src="http://skysedge.us/forum/images/smilies/icon_e_wink.gif" width="15" height="17" alt=";)" title="Wink"> <br><br>Well done on finding the temporary fix with: <span style="color:#00BF00">pinMode(SS, INPUT);</span><br><br>You understand the problem now... but you'll need real <em class="text-italics"><strong class="text-strong">"Try SCE to Aux"</strong></em> magic for it to work well enough for mission success.<br><br>ATmega2560 datasheet section 21.1.2:<blockquote class="uncited"><div>If SS is configured as an input, it must be held high to ensure Master SPI operation. If the SS pin is driven low by<br>peripheral circuitry when the SPI is configured as a Master with the SS pin defined as an input, the SPI system<br>interprets this as another master selecting the SPI as a slave and starting to send data to it. To avoid bus conten-<br>tion, the SPI system takes the following actions:<br>1. The MSTR bit in SPCR is cleared and the SPI system becomes a Slave. As a result of the SPI becoming a<br>Slave, the MOSI and SCK pins become inputs.</div></blockquote>Therefore when the FONA Tx pin pulls SS low, the ATmega SPI will switch to slave and the e-paper will lose SPI data and clock unless you perform some <em class="text-italics">"SCE to Aux"</em> magic with registers and interrupts. This might get the crew home but it's not the smooth, polished SpaceX solution  <img class="smilies" src="http://skysedge.us/forum/images/smilies/icon_lol.gif" width="15" height="17" alt=":lol:" title="Laughing"> <br><br>Sorry, no idea where the space metaphors are coming from.<br><br> <img class="smilies" src="http://skysedge.us/forum/images/smilies/icon_idea.gif" width="15" height="17" alt=":idea:" title="Idea"> Perhaps I should post a succinct version of the contention issue in another thread. Anyone support my (reluctant) view that a hardware mod (moving the FONA Tx wire) is the way forward?<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1724">SteveC</a> — Mon May 25, 2020 11:55 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[chaza]]></name></author>
		<updated>2020-05-25T19:22:54</updated>

		<published>2020-05-25T19:22:54</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1582#p1582</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1582#p1582"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1582#p1582"><![CDATA[
Ok, putting the " pinMode(SS, INPUT)" in  setup() did not work. It does work when placed in loop() but only after these statements:<br><br>void loop(){<br><br>if (CallOn == true){<br>digitalWrite(HookLED, HIGH);<br>}<br>else if (CallOn == false){<br>digitalWrite(HookLED, LOW);<br>}<br><br>if (digitalRead(ModeSwitch_631) == LOW){<br>mode = 1;<br>}<br> else if (digitalRead(ModeSwitch_NP) == LOW){<br>mode = 2;<br>}<br>else if (digitalRead(ModeSwitch_alt) == LOW){<br>mode = 3;<br>}<br><br>    pinMode(SS, INPUT);<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1749">chaza</a> — Mon May 25, 2020 7:22 pm</p><hr />
]]></content>
	</entry>
		<entry>
		<author><name><![CDATA[chaza]]></name></author>
		<updated>2020-05-25T18:58:25</updated>

		<published>2020-05-25T18:58:25</published>
		<id>http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1581#p1581</id>
		<link href="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1581#p1581"/>
		<title type="html"><![CDATA[Re: Firmware stuff]]></title>

		
		<content type="html" xml:base="http://skysedge.us/forum/viewtopic.php?t=1486&amp;p=1581#p1581"><![CDATA[
I've been trying to wrap my head around all the work Steve has done here and, although I'm not 100% sure I grasp it all, that hasn't stopped me from expending a lot of time trying to debug this FONA serial stuff! At first I did not understand the conflict that Steve has pointed out between the FONA TX and the SS functionality. Anyway, as a gamble I added this line -- I added it to BatteryLevel() thinking I might need it before any call to read serial data -- but this one call seems to have "fixed" it so maybe it can go anywhere after the epaper display is initialialized:<br><br>            pinMode(SS, INPUT);<br><br>I can now reliably get battery and SignalStrength values. Also, the display still works ok...<p>Statistics: Posted by <a href="http://skysedge.us/forum/memberlist.php?mode=viewprofile&amp;u=1749">chaza</a> — Mon May 25, 2020 6:58 pm</p><hr />
]]></content>
	</entry>
	</feed>
